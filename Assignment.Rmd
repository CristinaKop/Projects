---
title: "Data Wrangling OLET"
author: "Cristina Koprinski"
date: "29/06/2021"
output:
  pdf_document:
    toc: yes
    toc_depth: '3'
  html_document:
    number_sections: yes
    self_contained: yes
    theme: flatly
    css: null
    toc: yes
    toc_depth: 3
    toc_float: yes
    code_folding: hide
    always_allow_html: true
subtitle: New York City Motor Vehicle Crash Data
---
<style>
h2 { /* Header 2 */
    font-size: 22px
}
</style>

<style>
h3 { /* Header 3 */
    font-size: 18px
}
</style>

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(tidy = FALSE, 
                      message = FALSE,
                      warning = FALSE,
                      echo = TRUE, 
                      fig.width=8,
                      fig.height=6,
                      fig.align = "center",
                      fig.retina = 4)

#To reproduce this report, change the working directory as required,
setwd('C:/a_USYD/Year 1/Semester 1/Data Wrangling OLET')

library(tidyverse)
library(ggplot2)
library(plotly)
library(openair)
library(NLP)
library(lubridate)
library(tibble)
library(ggmap)
library(tmaptools)
library(skimr)
library(naniar)
library(kableExtra)

#Read the data and replace all empty variables with NA
MVC = read.csv("MVC.csv", na.strings=c("", "NA"), strip.white=TRUE)

#Make it as a tibble for readability
MVC <- as_tibble(MVC)

```
# Executive Summary

The purpose of this report is to investigate the distribution in the location of the streets with the most crashes, as well as potential reasons why this is the case for the New York State Department of Transportation (NYDP) to improve road safety. It was found that the most incidents occur in the Manhattan and Brooklyn areas, and that the streets with the most incidents also had the highest number of death and injury rates.

In order to reveal the most fatal streets (by death and injuries), death and injury rates were calculated and plotted on a map, revealing that the streets with the most casualties are not the most fatal per capita.

# Initial Data Analysis 

## Background 
The New York State Department of Transportation (NYDT) is looking to investigate the location and fatalities of road accidents in New York in order to improve safety. This report aims to investigate the location of the top accidents by frequency, and the top accidents by their death rate and injury rate. 

## Assessment of Data Provenance
Data Provenance refers to the reliability and reproducibility of the data. In order to assess data provenance, the W3C group’s (Data Provenance, n.d.) requirements were used (shown below). To quantify this measure, the NYC dataset was awarded a score out of 17, using the information provided by the City of New York (Motor Vehicle Collisions - Crashes | NYC Open Data, 2021).

![Data Provenance Assessment](DP.png)
![Score indicator](range.png)

The data originates from the City of New York (Motor Vehicle Collisions - Crashes | NYC Open Data, 2021). When inspecting the website in which the data can be accessed, it was found that 
the data was sourced from the New York Police, however, the data process is not known (how the data was collected and entered into the database, and how it was provided to the City of New York). This represents a limitation in Data Provence as the flow of data cannot be traced. This undermines the reliability of the data as there could be typos in the data transfer from the police department to the database, or incorrect observations recorded. In addition, there is no information provided on how the data changed over time - only that it has been updated. It is assumed that this refers to the addition of new records depending on the month that has most recently passed, however, this is not explicitly stated and could mean that other variables also changed. This could also introduce bias during the modification of the data month to month, however, this remains unknown as the process is unknown. There is also no documentation on why a particular decision relating to the data was made (e.g. if some records changed from version to version) as well as showing how data was derived (e.g. whether a police went to the site straight after a crash to record the results). This reduces the reproducibility of the data (e.g. if the NYT wanted to examine averages across many years), as the methodology in how the data was collected is unknown. It is for these reasons that the data provenance is assessed to be poor (see the assessment above).

Despite this the reliability of the data is high as government organisations aim to provide data that is accurate and credible to inform the public. This means that although there are uncertainties in how the data was collected and traced, significant data collection and processing error/bias is considered to be low, as it was collected by a public institution. 

## Domain Knowledge
As mentioned above, the data has been sourced from the City of New York, and outlines details related to accidents on the road. The data structure is outlined below.

```{r}
# Glimpse Function [From tidyverse package]
MVC %>% glimpse()
```
Using the glimpse() function from the tidyverse package, we can see that the data has 29 columns with around 1.6 million records. There are also only two types of variables present: ints and chars. This representation also reveals that during the data reading, null values were set to NA as specified, making data wrangling more efficient.
```{r}
# Skim Function [From skimr package]
 kable(skim(MVC))
```
The skim() function from the skimr package provides us with summary statistics for the data to be used when formulating our research questions. From this, we can see that there are thousands of missing variables for each column.

```{r}
# Summary Function [From base package -- preinstalled!]
MVC %>% summary()
```
The summary() function from the base package in R shows us key information relating to the min and max values of incidents e.g. death rate, injury rate etc, as well as the range of incidents in New York (lat/long summary statistics). This reveals that our research questions should aim to focus on specific areas in New York (as the data seems to be spread across all of New York), and/or the specific crash conditions.

In addition, we can see that the mean of all injury/death values across all types of vehicles rounds to 0. This indicates that the expected value of using a motor vehicle is not to have an accident. In addition, for all the quantifyable data types the IQR is 0 (because Q3 and Q1 are zero), hence, outliers in the injury/death values are those where an injury/death has occurred. This means that when we are investigating death/injury rates, we will be investigating the outliers, which are the least likely to occur on average.

An ethical concern relating to the data is its use by companies for profit. For example, through this data, insurance companies could discover that people who live in a certain area live within roads that have many accidents. Hence, they could increase the premium of people living in these areas. 

The main limitation in the data is missing points, primarily related to the coordinates of the accidents. Initially, the averages of all crash points on a street were calculated in order to mitigate this, however, due to the missing values this reduced the accuracy in the location of the points when plotted on the map. This is because when taking the averages of the latitude and longitude, the points do not lie on the street, and sometimes not on land. An API to return the center-point of an accident street was used instead. However, this does not reveal the general area on the street in which the incidents occurred, meaning that the NYDT is only given the location of the center point on the street in the map.


## Exploration of Missing Data and Outliers
Note: a limit in processing power meant that the vis_miss() function could not be used on the entire dataset, hence, it was used on columns in which the analysis was concerned.

```{r}
# vis_miss function [From visdat or naniar packages]
street_name = subset(MVC, select= c(5, 6, 8))
vis_miss(street_name, warn_large_data = FALSE)
```
Using the vis_miss() function from the naniar package reveals that within the latitude and longitude data 12.2% of the records have no entries. This could impact the plotting of the crashes by street on the map, as not all points are recorded. In addition, 19.62% of street names are missing for a crash, this could mean that some data may be missed when processing the aggregate of all incidents by street name.

```{r}
# vis_miss function [From visdat or naniar packages]
street_name = subset(MVC, select= c(11:18))
vis_miss(street_name, warn_large_data = FALSE)
```
Using the vis_miss() function on the death and injury data reveals that there almost no missing variables. This is means that analysis on the death and injury data for the accidents will be very reliable as most of the sample population is recorded. Note: the data is a sample of all accidents as not all accidents are reported to the police.

Note: Analysis of outliers is provided under the summary() function explanation in 'Domain Knowledge'.

# Research Question 1 - What are the locations of the most frequent road incidents?
The NYDT is interested in the location of the most frequent road incidents, in order to implement measures to reduce accidents, such as increasing police in these areas to enforce road rules. In order to answer this question, the top 100 crash locations had to be retrieved.

This section of code wrangles the data by calculating the top 100 roads by summing their occurrence in the MVC data-set. We then retrieve the map data of New York from StamenMaps to plot the locations of the incidents.
```{r, include=FALSE}
#Get the map of New York from the StamenMap server
new_york <- get_stamenmap(bbox = c(left = -74.25, bottom = 40.557, right = -73.5, top = 41), maptype = c("terrain"))

#Calculate the top 100 crash locations using the aggregate function.
street_crash_all = subset(MVC, is.na(ON.STREET.NAME) == FALSE, select = c(8))
street_crash_all = aggregate(x = street_crash_all, by = list(street_crash_all$ON.STREET.NAME), FUN = length)
street_crash_all = street_crash_all %>% arrange(desc(ON.STREET.NAME))

#Sort the sum of the crashes by their street name from largest to smallest and take the top 100.
street_crash = street_crash_all %>% arrange(desc(ON.STREET.NAME)) %>% slice(1:100)

#Rename the columns.
colnames(street_crash) <- c('Street', 'Accidents')

#Get the lat/long for the top 100 streets.
#NOTE: taking the average of the lat/long for each location was taken however it led to points ending up in the water. The API takes the center point of the street.
geocode = subset(street_crash, select = c(1))
for (i in 1:nrow(geocode)){
  geocode[i, 1] = paste(geocode[i, 1], ',New York')
}

#Here we use an API in order to retrieve the center-point of lat/long locations.
locations <- geocode_OSM(geocode$Street)
locations_plot = subset(locations, select = c(2, 3))
locations_plot_top_10 = head(locations_plot, 10)
```

```{r}
#Reorder the Street trace value by the incidents. This is because plotly takes the alphabetical order s the default.
street_crash$Street <- reorder(street_crash$Street, X = -street_crash$Accidents)

#In ploy_ly
fig_street <- plot_ly(
  data = street_crash,
  x = street_crash$Street,
  y = street_crash$Accidents,
  type = "bar",
  name = street_crash$Street
)
#Remove the x-axis names as they are large (user's can hover over the bars for the types).
fig_street <- fig_street %>% layout(title = 'Top 100 Streets With The Most Accidents In New York', 
                      xaxis = list(showticklabels = FALSE),
                      yaxis = list(title = "Number Of Offences"),
                      showlegend = FALSE)
fig_street
```
This graph shows that the most common reason for an accident is due to driver distraction, and that the the top 15 reasons are due to human error, not road issues. In addition, a study conducted by Shuai Yu ,Yuanhua Jia and Dongye Sun (Yu et al., 2019) reveals that the most common reasons for accidents are due to distracted driving, supporting the finds above. Note; we only include the top 15 as beyond these they approach 10k.
```{r}
#Calculate the top 100 reasons for crashes omitting the unspecified ones.
reasons = subset(MVC, CONTRIBUTING.FACTOR.VEHICLE.1 != 'Unspecified', select = c(19))
reasons = aggregate(x = reasons, by = list(reasons$CONTRIBUTING.FACTOR.VEHICLE.1), FUN = length)
reasons = reasons %>% arrange(desc(CONTRIBUTING.FACTOR.VEHICLE.1)) %>% slice(1:15)

#Reorder trace value by the incidents. This is because plotly takes the alphabetical order s the default.
reasons$Group.1 <- reorder(reasons$Group.1, X = -reasons$CONTRIBUTING.FACTOR.VEHICLE.1)

#In ploy_ly
fig_reasons <- plot_ly(
  data = street_crash,
  x = reasons$Group.1,
  y = reasons$CONTRIBUTING.FACTOR.VEHICLE.1,
  type = "bar",
  name = reasons$Group.1
)
#Remove the x-axis names as they are large (user's can hover over the bars for the types).
fig_reasons <- fig_reasons %>% layout(title = 'The 100 Most Common Cause of a Crash', 
                      xaxis = list(showticklabels = FALSE),
                      yaxis = list(title = "Number Of Offences"),
                      showlegend = FALSE)
fig_reasons
```


Map of the top 100 accident streets with the top 10 in blue and the rest in red.
```{r}
top10 = street_crash %>% arrange(desc(Accidents)) %>% slice(1:10)

#Map the top 100 crash sites on the map
ggmap(new_york)+
  geom_point(data = locations_plot, aes(x = lon, y = lat), colour = "red", size = 1)+
  geom_point(data = locations_plot_top_10, aes(x = lon, y = lat), colour = "blue", size = 1)+
  labs(title='Top 100 Locations of Motor Mehicle Incidents New York')+
  theme(plot.title = element_text(size=11))

```

## Conclusion
From the analysis above it reveals that the majority of accidents occur in central New York in the districts of New York City and Brooklyn. From the graph data we can see three main clusters in: Lower Manhattan, The Financial District and Bedford-Stuyvesant.

According to research conducted by Helge Holden and Nils Henrik Risebro on the distribution of traffic in New York (Holden & Risebro, 1995), Manhattan and Brooklyn were found to be some of the most busy areas. In combination with the clusters shown above, this could imply a correlation between the quantity of people on roads and traffic incidents. However, further anaysis is needed to confirm this.

In additon, as the top 15 most common reasons for traffic incidents are related to human error by the driver, the NYDT could increase police enforcement within these areas to reduce accidents.

# Research Question 2 - Are the top accident locations the most deadly?
Based off the results of the first research question, the NYDT would like to know whether the Top 100 roads are the most deadly by death and injury rates.

```{r}
#This code secion calculates the sum of all injury and deaths for fatal accidents.
#NOTE: The processing time of this block is 50 mins as the data set contains 1.6 million records.

#Function: returns the number of persons injured
calculations <- function(streetName, column) {
  #Get the average of the lat/long for the street
  test = subset(MVC, ON.STREET.NAME == streetName, select = c(column))
  return(sum(test, na.rm = TRUE))
}

death_rate_all = street_crash_all
for (i in 1:nrow(death_rate_all)){
  n = death_rate_all[i, 1]
  death_rate_all$persons.injured[i] = calculations(n, 11)
  death_rate_all$persons.killed[i] = calculations(n, 12)
  death_rate_all$pedestrians.injured[i] = calculations(n, 13)
  death_rate_all$pedestrians.killed[i] = calculations(n, 14)
  death_rate_all$cyclists.injured[i] = calculations(n, 15)
  death_rate_all$cyclists.killed[i] = calculations(n, 16)
  death_rate_all$motorists.injured[i] = calculations(n, 17)
  death_rate_all$motorists.killed[i] = calculations(n, 18)
}


#Sum all of the injured and killed persons.
for (i in 1:nrow(death_rate_all)){
  n = death_rate_all[i, 1]
  death_rate_all$all.killed[i] = (death_rate_all[i, 4] + death_rate_all[i, 6] + death_rate_all[i, 8] + death_rate_all[i, 10])
  death_rate_all$all.injured[i] = (death_rate_all[i, 3] + death_rate_all[i, 5] + death_rate_all[i, 7] + death_rate_all[i, 9])
}


#Reorder the rows by the roads with the most people killed and take the Top 100.
#NOTE: different than the roads with the most incidents
death_rate_all$Group.1 <- reorder(death_rate_all$Group.1, X = -death_rate_all$ON.STREET.NAME)
death_rate_100 = subset(head(death_rate_all, 100), select = c(1, 2, 11, 12))

#Create a graph of the top 100 incidents vs their death rate
fig_100_killed <- plot_ly(
  data = death_rate_100,
  x = death_rate_100$Group.1,
  y = death_rate_100$all.killed,
  #color = ~Street,
  type = "bar",
  name = death_rate_100$Group.1
)

#Remove the x-axis names as they are large (user's can hover over the bars for the types)
fig_100_killed <- fig_100_killed %>% layout(
                      xaxis = list(showticklabels = FALSE),
                      yaxis = list(title = "Deaths"),
                      showlegend = FALSE)

deadly_graph = subset(death_rate_all, select = c(1, 11, 12))
deadly_graph = head(deadly_graph, 100)

#Create a graph of the most deadly roads by death count (not necessarily the roads with the most incidents)
fig_killed <- plot_ly(
  data = deadly_graph,
  x = deadly_graph$Group.1,
  y = ~deadly_graph$all.killed,
  type = "bar",
  name = deadly_graph$Group.1
)

fig_killed <- fig_killed %>% layout(title = "Deaths",
                      xaxis = list(showticklabels = FALSE),
                      yaxis = list(title = "Deaths"),
                      showlegend = FALSE,
                      xaxis = list(categoryorder = "array"))


subplot_both = subplot(fig_100_killed, fig_killed)
subplot_both %>% layout(annotations = list(
 list(x = 0 , y = 1.00, text = "Number of Deaths On The Streets With The Most Incidents", showarrow = F, xref='paper', yref='paper'),
  list(x = 0.9 , y = 1.00, text = "Most Deadly Streets", showarrow = F, xref='paper', yref='paper'))
)
```
The graphs are exactly the same, showing that the most deadly roads by persons killed are the roads which have the most accidents.

The graph below is the same as the above but for the persons injured.
```{r}
fig_100_injured <- plot_ly(
  data = death_rate_100,
  x = death_rate_100$Group.1,
  y = death_rate_100$all.injured,
  #color = ~Street,
  type = "bar",
  name = death_rate_100$Group.1
)

#Remove the x-axis names as they are large (user's can hover over the bars for the types)
fig_100_injured <- fig_100_injured %>% layout(
                      xaxis = list(showticklabels = FALSE),
                      yaxis = list(title = "Deaths"),
                      showlegend = FALSE)

deadly_graph = subset(death_rate_all, select = c(1, 11, 12))
deadly_graph = head(deadly_graph, 100)

fig_injured <- plot_ly(
  data = deadly_graph,
  x = deadly_graph$Group.1,
  y = ~deadly_graph$all.injured, 
  type = "bar",
  name = deadly_graph$Group.1
)

fig_injured <- fig_injured %>% layout(title = "Injuries",
                      xaxis = list(showticklabels = FALSE),
                      yaxis = list(title = "Injuries"),
                      showlegend = FALSE,
                      xaxis = list(categoryorder = "array"))


subplot_both = subplot(fig_100_injured, fig_injured)
subplot_both %>% layout(annotations = list(
 list(x = 0 , y = 1.025, text = "Number of Injuries On The Streets With The Most Incidents.", showarrow = F, xref='paper', yref='paper'),
  list(x = 0.9 , y = 1.025, text = "Streets With The Most Injuries", showarrow = F, xref='paper', yref='paper'))
)

```
The graphs are exactly the same, showing that the most deadly roads by persons injured are the ones with the most incidents.

However, in order to reveal the most deadly rates we define a death and injury statistic to be the death/injury divided by the number of incidents on that road. 

The bump chart below shows the change in the roads with the most deaths (by quantity) to the most deadly roads (by the death rate).
```{r}
#Let rates = death_rate_100 (based on the proven fact that the death and injury graphs are the same)
rates = death_rate_100
for (i in 1:nrow(death_rate_100)){
  n = death_rate_100[i, 1]
  rates$deathRate[i] = (rates[i, 3])/(rates[i, 2])
  rates$injuryRate[i] = (rates[i, 4])/(rates[i, 2])
}

#Sort by deathRate and injury rate and plot the two graphs.
rates_death = subset(rates, select = c(1, 5))
rates_injury = subset(rates, select = c(1, 6))

rates_death = rates_death %>% arrange(desc(deathRate)) %>% mutate(rank = row_number()) %>% mutate(day = 1)
rates_death = subset(rates_death, select = -c(2))
rates_death <- rates_death[, c(1, 3, 2)]

#Injury
rates_injury = rates_injury %>% arrange(desc(injuryRate)) %>% mutate(rank = row_number()) %>% mutate(day = 1)
rates_injury = subset(rates_injury, select = -c(2))
rates_injury <- rates_injury[, c(1, 3, 2)]

#Rename the columns
colnames(rates_death) <- c('street', 'day', 'rank')
colnames(rates_injury) <- c('street', 'day', 'rank')

death_rate_100_bump = death_rate_100 %>% mutate(rank = row_number())  %>% mutate(day = 2)
death_rate_100_bump = subset(death_rate_100_bump, select = c(1, 5, 6))
death_rate_100_bump <- death_rate_100_bump[, c(1, 3, 2)]


#Rename the columns
colnames(death_rate_100_bump) <- c('street', 'day', 'rank')


bump_chart = rbind(death_rate_100_bump, rates_death)
injury_chart = rbind(death_rate_100_bump, rates_injury)


ggplot(bump_chart, aes(x = day, y = rank, group = street)) +
  geom_line(aes(color = street, alpha = 1), size = 1, show.legend = FALSE) +
  geom_point(aes(color = street, alpha = 1), size = 2, show.legend = FALSE) +
  scale_y_reverse(breaks = 1:nrow(bump_chart))+
  scale_x_continuous(breaks = 1:2, minor_breaks = 1:2, expand = c(.05, .05)) +
  geom_text(data = bump_chart %>% filter(day == "2"),
            aes(label = street, x = 0.5) , hjust = 0.1, fontface = "bold", color = "#888888", size = 1.5) +
  geom_text(data = bump_chart %>% filter(day == "1"),
            aes(label = street, x = 2.5) , hjust = 0.9, fontface = "bold", color = "#888888", size = 1.5) +
  theme(axis.text.y = element_text(size = 4.5), axis.text.x=element_blank())+
  labs(title='Top 100 Death Frequency vs Most Deadly Roads Rank Change',
          x ="Death Frequency                                                       Death Rate", 
        y = "Frequency")

```
As shown in the below graph, the top 10 roads dramatically change.
```{r}
ggplot(bump_chart, aes(x = day, y = rank, group = street)) +
  geom_line(aes(color = street, alpha = 1), size = 1, show.legend = FALSE) +
  geom_point(aes(color = street, alpha = 1), size = 2, show.legend = FALSE) +
  coord_cartesian(ylim = c(10, 1)) +
  scale_y_reverse(breaks = 1:10)+
  geom_text(data = bump_chart %>% filter(day == "2"),
            aes(label = street, x = 0.5) , hjust = 0.1, fontface = "bold", color = "#888888", size = 2) +
  geom_text(data = bump_chart %>% filter(day == "1"),
            aes(label = street, x = 2.5) , hjust = 0.9, fontface = "bold", color = "#888888", size = 2) +
  scale_x_continuous(breaks = 1:2, minor_breaks = 1:2, expand = c(.05, .05)) +
  theme(axis.text.y = element_text(size = 6),
        axis.text.x=element_blank())+
  labs(title='Top 10 Death frequency vs Most Deadly Roads Rank Change',
          x ="Death Frequency                                                       Death Rate", 
        y = "Rank")
```
The bump chart below shows the change in the roads with the most injuries (by quantity) to the most deadly roads (by the injury rate).
```{r}
ggplot(injury_chart, aes(x = day, y = rank, group = street)) +
  geom_line(aes(color = street, alpha = 1), size = 1, show.legend = FALSE) +
  geom_point(aes(color = street, alpha = 1), size = 2, show.legend = FALSE) +
  scale_y_reverse(breaks = 1:nrow(injury_chart))+
  scale_x_continuous(breaks = 1:2, minor_breaks = 1:2, expand = c(.05, .05)) +
  geom_text(data = injury_chart %>% filter(day == "2"),
            aes(label = street, x = 0.5) , hjust = 0.1, fontface = "bold", color = "#888888", size = 1.5) +
  geom_text(data = injury_chart %>% filter(day == "1"),
            aes(label = street, x = 2.5) , hjust = 0.9, fontface = "bold", color = "#888888", size = 1.5) +
  theme(axis.text.y = element_text(size = 4.5), axis.text.x=element_blank())+
  labs(title='Top 100 Injury frequency vs most deadly roads rank change',
          x ="Injury Frequency                                                       Injury Rate", 
        y = "Rank")

```
```{r}
ggplot(injury_chart, aes(x = day, y = rank, group = street)) +
  geom_line(aes(color = street, alpha = 1), size = 1, show.legend = FALSE) +
  geom_point(aes(color = street, alpha = 1), size = 2, show.legend = FALSE) +
  coord_cartesian(ylim = c(10, 1)) +
  scale_y_reverse(breaks = 1:10)+
  geom_text(data = injury_chart %>% filter(day == "2"),
            aes(label = street, x = 0.5) , hjust = 0.1, fontface = "bold", color = "#888888", size = 2) +
  geom_text(data = injury_chart %>% filter(day == "1"),
            aes(label = street, x = 2.5) , hjust = 0.9, fontface = "bold", color = "#888888", size = 2) +
  scale_x_continuous(breaks = 1:2, minor_breaks = 1:2, expand = c(.05, .05)) +
  theme(axis.text.y = element_text(size = 6),
        axis.text.x=element_blank())+
  labs(title='Top 10 Injury frequency vs Most Deadly Roads (by injury) Rank Change',
          x ="Injury Frequency                                                       Injury Rate", 
        y = "Rank")
# Reflection on Data Wrangling
```
As shown in the below graph, the top 10 roads dramatically change.
```{r}
#Death Rate
rates_death$street = as.character(rates_death$street)
geocode_death_rate = subset(rates_death, select = c(1))
geocode_death_rate = geocode_death_rate %>% slice(1:10)
for (i in 1:nrow(geocode_death_rate)){
  geocode_death_rate[i, 1] = paste(geocode_death_rate[i, 1], ',New York')
}

locations_death_rate <- geocode_OSM(geocode_death_rate$street)
locations_death_rate = subset(locations_death_rate, select = c(2, 3))


#Injury Rate
rates_injury$street = as.character(rates_injury$street)
geocode_injury_rate = subset(rates_injury, select = c(1))
geocode_injury_rate = geocode_injury_rate %>% slice(1:10)
for (i in 1:nrow(geocode_injury_rate)){
  geocode_injury_rate[i, 1] = paste(geocode_injury_rate[i, 1], ',New York')
}

locations_injury_rate <- geocode_OSM(geocode_injury_rate$street)
locations_injury_rate = subset(locations_injury_rate, select = c(2, 3))

#Map the top 100 crash sites on the map
ggmap(new_york)+
  geom_point(data = locations_plot, aes(x = lon, y = lat), colour = "red", size = 1)+
  geom_point(data = locations_plot_top_10, aes(x = lon, y = lat), colour = "blue", size = 1)+
  geom_point(data = locations_death_rate, aes(x = lon, y = lat), colour = "green", size = 2)+
  geom_point(data = locations_injury_rate, aes(x = lon, y = lat), colour = "orange", size = 2)+
  labs(title='Top 100 Locations of Motor Mehicle Incidents New York')+
  theme(plot.title = element_text(size=11))

```

This graph reveals that the spread of the deaths and injuries are relatively consistent across the streets.
```{r}
boxplot_no_zeros = subset(death_rate_all, all.killed != 0)
boxplot_no_zeros = subset(boxplot_no_zeros, select = c(1, 11, 12))

boxplot_no_zeros = boxplot_no_zeros %>% pivot_longer(-Group.1, names_to = 'type', values_to = 'number')

ggplot(boxplot_no_zeros, aes(x = number, fill = type))+
  geom_boxplot()+
  facet_wrap(~type, scales = "free")
```
However, when we plot the top 10 deadliest roads by deaths (green) and injury (orange) we find new clusters

This map shows the locations of Top 10 the roads with the most incidents (blue), death rate (green) and injury rate (red).
```{r}
geocode_death_rate = rates_death %>% slice(1:10)
geocode_death_rate$street = as.character(geocode_death_rate$street)

for (i in 1:nrow(geocode_death_rate)){
  geocode_death_rate[i, 1] = paste(geocode_death_rate[i, 1], ',New York')
}

locations_death_rate <- geocode_OSM(geocode_death_rate$street)
locations_death_rate = subset(locations_death_rate, select = c(2, 3))

geocode_injury_rate = rates_injury %>% slice(1:10)
geocode_injury_rate$street = as.character(geocode_injury_rate$street)

for (i in 1:nrow(geocode_injury_rate)){
  geocode_injury_rate[i, 1] = paste(geocode_injury_rate[i, 1], ',New York')
}

locations_injury_rate <- geocode_OSM(geocode_injury_rate$street)
locations_injury_rate = subset(locations_injury_rate, select = c(2, 3))


ggmap(new_york)+
  geom_point(data = locations_plot_top_10, aes(x = lon, y = lat), colour = "blue", size = 1)+
  geom_point(data = locations_death_rate, aes(x = lon, y = lat), colour = "green", size = 1)+
  geom_point(data = locations_injury_rate, aes(x = lon, y = lat), colour = "orange", size = 1)+
  labs(title='Most Frequent and Most Deadly Roads')+
  theme(plot.title = element_text(size=11))

```

## Conclusion
This shows that the roads with have the most incidents are not necessarily the most fatal (by deaths and injury) per the number of incidents. In addition, the spread of deaths and injuries are relatively the same, revealing consistency.

# Reflection
Data wrangling tools were extremely useful in providing answers to my research questions. In particular, the ability to format the street data into latitude and longitude for the center-points of the streets using the Stamen Map API allowed for points to be plotted on the correct streets. This was in contrast with taking the averages of the latitude and longitude points for the streets which contained missing data, and which led to points being plotted outside the actual street.

My use of the subset and mutate functions have been used heavily in my data wrangling process, especially when calculating the aggregate of all deaths and injuries. Through processing the data in this way, I was able to synthesis data on the total number of deaths and injuries for each street. This then allowed me to calculate the death and injury rate per number of incidents, rather than just the cumulative total, revealing that the most fatal streets are not the ones with the most incidents.

# References
A. (n.d.). Data provenance - ANDS. Data Provenance - ANDS. Retrieved July 5, 2021, from https://www.ands.org.au/working-with-data/publishing-and-reusing-data/data-provenance

Motor Vehicle Collisions - Crashes | NYC Open Data. (2021, July 3). Motor Vehicle Collisions - Crashes | NYC Open Data. https://data.cityofnewyork.us/Public-Safety/Motor-Vehicle-Collisions-Crashes/h9gi-nx95

Terms of Use | City of New York. (n.d.). Terms of Use | City of New York. Retrieved July 5, 2021, from https://www1.nyc.gov/home/terms-of-use.page

Holden, H., & Risebro, N. H. (1995). A Mathematical Model of Traffic Flow on a Network of Unidirectional Roads. SIAM Journal on Mathematical Analysis, 26(4), 999–1017. https://doi.org/10.1137/s0036141093243289

Yu, S., Jia, Y., & Sun, D. (2019). Identifying Factors that Influence the Patterns of Road Crashes Using Association Rules: A case Study from Wisconsin, United States. Sustainability, 11(7), 1925. https://doi.org/10.3390/su11071925